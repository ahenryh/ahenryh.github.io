<!-- Fragment for embedding histogram (no <html>/<head>) -->
{{ bokeh_css | safe }}
{{ bokeh_js | safe }}

<div class="fragment-histo">
  <h3 class="mb-3">Nationalités des personnes d'origine étrangère</h3>
  <div class="row mt-2">
    <div class="col-md-5">
      <label for="region" class="form-label">Région :</label>
      <select id="region" class="form-select">
        <option value="">--Choisir une région--</option>
        {% for region in regions %}
          <option value="{{ region }}">{{ region }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-7">
      <label for="epci" class="form-label">EPCI :</label>
      <select id="epci" class="form-select">
        <option value="">--Choisir une EPCI--</option>
      </select>
    </div>
  </div>

  <div id="plot" class="mt-3"></div>
</div>

<script>
function clearPlotContainer() {
  document.getElementById("plot").innerHTML = "";
}

async function loadEPCIs(region) {
  if (!region) {
    document.getElementById("epci").innerHTML = "<option value=''>--Choisir une EPCI--</option>";
    clearPlotContainer();
    return;
  }

  const resp = await fetch(`/histogrammes/get_epci?region=${encodeURIComponent(region)}`);
  const epcis = await resp.json();

  const sel = document.getElementById("epci");
  sel.innerHTML = "<option value=''>--Choisir une EPCI--</option>";

  epcis.forEach(e => {
    const o = document.createElement("option");
    o.value = o.text = e;
    sel.appendChild(o);
  });

  if (epcis.length > 0) {
    sel.selectedIndex = 1;
    await loadPlot(region, epcis[0]);
  } else {
    clearPlotContainer();
  }
}

async function loadPlot(region, epci) {
  clearPlotContainer();
  if (!region || !epci) return;

  const resp = await fetch(`/histogrammes/get_data_plot?region=${encodeURIComponent(region)}&epci=${encodeURIComponent(epci)}`);
  const data = await resp.json();

  if (data.error) {
    document.getElementById("plot").innerText = data.error;
    return;
  }
  
  Bokeh.embed.embed_item(data);
}

if (document.getElementById("region")) {
  document.getElementById("region").addEventListener("change", function() {
    loadEPCIs(this.value);
  });
}

if (document.getElementById("epci")) {
  document.getElementById("epci").addEventListener("change", function() {
    const region = document.getElementById("region").value;
    loadPlot(region, this.value);
  });
}

(function initial() {
  const regionSel = document.getElementById("region");
  if (regionSel && regionSel.options.length > 1) {
    regionSel.selectedIndex = 1;
    loadEPCIs(regionSel.value);
  }
})();
</script>
